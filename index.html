<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprende Python Interactivo</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta de colores inspirada en el tema oscuro y morado/铆ndigo */
        :root {
            --color-bg-dark: #1e1231; /* Morado/ndigo muy oscuro */
            --color-primary: #8b5cf6; /* gdigo medio (P煤rpura) */
            --color-secondary: #c4b5fd; /* gdigo claro */
            --color-text-light: #f3f4f6;
            --color-text-dark: #1f2937;
            /* Nuevos colores base para feedback */
            --color-success-base: #10b981; /* Esmeralda/Verde */
            --color-error-base: #ef4444; /* Rojo */
        }

        /* Fondo degradado oscuro */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--color-bg-dark) 0%, #3e1f75 100%);
            color: var(--color-text-light);
            min-height: 100vh;
        }

        /* Estilo Glassmorphism para los contenedores principales (simulando los paneles flotantes) */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.1); /* Blanco semitransparente */
            backdrop-filter: blur(10px); /* Desenfoque */
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Estilo para el editor de c贸digo: debe ser legible y contrastar */
        .code-editor {
            font-family: monospace;
            background-color: rgba(0, 0, 0, 0.7); /* Fondo m谩s oscuro para c贸digo */
            color: #4CAF50; /* Texto verde neon para c贸digo (contraste alto) */
            padding: 1rem;
            border-radius: 12px;
            resize: none;
            min-height: 200px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        /* Resaltar el tema actual en el sidebar */
        .nav-item {
            color: var(--color-text-light);
            padding: 0.75rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background: var(--color-primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.5);
        }

        /* Estilo para el texto de c贸digo en las explicaciones */
        code {
            background-color: rgba(139, 92, 246, 0.2); /* Fondo p煤rpura suave */
            color: var(--color-secondary);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Ajustes de color de texto para las secciones de contenido */
        #topic-title, #task-description, #theory-section, .text-content {
            color: var(--color-text-light);
        }

        /* Estilo para los botones */
        .custom-button {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .run-button {
            background-color: var(--color-success-base); /* Verde brillante */
            color: var(--color-text-dark);
        }
        .run-button:hover {
            background-color: #059669; /* Verde oscuro */
            transform: translateY(-2px);
        }

        .next-button {
            background-color: var(--color-primary);
            color: white;
        }
        .next-button:hover {
            background-color: #7c3aed;
            transform: translateY(-2px);
        }

        /* ------------------------------------------
        ESTILOS PARA EL REA DE RESULTADOS (Glassmorphism)
        ------------------------------------------
        */
        .feedback-success {
            /* Fondo ligeramente verde y semitransparente, mezclado con el fondo oscuro */
            background-color: rgba(16, 185, 129, 0.1); /* Verde esmeralda (10%) */
            border: 1px solid rgba(16, 185, 129, 0.5); /* Borde suave de color 茅xito */
            color: var(--color-secondary); /* Texto p煤rpura claro */
            backdrop-filter: blur(5px);
        }
        .feedback-error {
            /* Fondo ligeramente rojo y semitransparente */
            background-color: rgba(239, 68, 68, 0.1); /* Rojo (10%) */
            border: 1px solid rgba(239, 68, 68, 0.5); /* Borde suave de color error */
            color: var(--color-secondary); /* Texto p煤rpura claro */
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- Encabezado (Header) - Fijo y con Glassmorphism suave -->
    <header class="p-4 sticky top-0 z-10 glass-panel shadow-2xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white tracking-wider">
                <span style="color: var(--color-primary);">PYTHON</span> INMERSIVO
            </h1>
            <span class="text-sm text-gray-300 hidden sm:block">Conceptos Esenciales</span>
        </div>
    </header>

    <!-- Contenedor Principal (Sidebar y Contenido) -->
    <div class="flex flex-1 max-w-7xl mx-auto w-full p-4 md:p-8">

        <!-- Navegaci贸n (Sidebar) - Contenedor Flotante -->
        <nav id="sidebar" class="w-64 p-4 mr-6 glass-panel hidden md:block self-start">
            <h2 class="text-xl font-semibold mb-4 text-white border-b border-gray-600 pb-2">Unidades</h2>
            <ul id="unit-list">
                <!-- Los 铆tems de las unidades se inyectar谩n aqu铆 por JavaScript -->
            </ul>
        </nav>

        <!-- rea de Contenido Principal - Contenedor Flotante -->
        <main class="flex-1">
            <div id="content-area" class="p-6 md:p-8 glass-panel shadow-2xl">
                
                <!-- T铆tulo del Tema -->
                <h2 id="topic-title" class="text-3xl font-extrabold text-white mb-4 border-b border-gray-600 pb-2"></h2>

                <!-- Explicaci贸n Te贸rica -->
                <section id="theory-section" class="mb-8 text-content leading-relaxed text-lg"></section>

                <!-- Escenario Din谩mico (Problema y Editor) -->
                <section id="scenario-section" class="p-6 rounded-xl border border-dashed border-gray-500 bg-black/20">
                    <h3 class="text-2xl font-semibold text-white mb-4">Escenario de Pr谩ctica</h3>
                    <p id="task-description" class="mb-4 text-content"></p>

                    <!-- Editor de C贸digo -->
                    <textarea id="code-editor" class="code-editor w-full focus:ring-var(--color-primary) focus:border-var(--color-primary)" placeholder="# Escribe tu c贸digo Python aqu铆..."></textarea>

                    <!-- Bot贸n de Ejecutar -->
                    <button id="run-button" onclick="runCode()" class="custom-button run-button mt-4">
                        Ejecutar / Verificar
                    </button>
                </section>

                <!-- rea de Resultados y Retroalimentaci贸n -->
                <div id="results-area" class="mt-6 p-4 rounded-xl hidden" role="alert">
                    <p id="feedback-message" class="font-medium text-lg"></p>
                    
                    <!-- Contenedor para la salida de la consola -->
                    <div id="console-output-container" class="mt-3 p-4 rounded-lg bg-black/50 text-green-400 text-sm overflow-auto max-h-40">
                        <strong class="text-white">Salida de la Consola:</strong>
                        <pre id="console-output" class="mt-1 font-mono whitespace-pre-wrap"></pre>
                    </div>

                    <button id="next-button" onclick="loadNextScenario()" class="custom-button next-button hidden mt-4">
                        Siguiente Unidad &rarr;
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Pie de P谩gina (Footer) -->
    <footer class="bg-black/30 p-4 mt-auto w-full">
        <div class="max-w-7xl mx-auto text-center text-sm text-gray-400">
            &copy; 2024 Proyecto de Aprendizaje Interactivo.
        </div>
    </footer>

    <script>
        // Funci贸n auxiliar para normalizar el c贸digo: elimina comentarios y espacios.
        function normalizeCode(code) {
            // 1. Remover l铆neas de comentarios
            const codeWithoutComments = code.split('\n')
                .filter(line => !line.trim().startsWith('#'))
                .join(' ');
            
            // 2. Simplificar m煤ltiples espacios a uno solo y remover espacios iniciales/finales
            // Luego, remover espacios completamente para comparaciones estrictas de sintaxis (ej: 'a=1' vs 'a = 1')
            return codeWithoutComments.replace(/\s+/g, ' ').trim().replace(/\s/g, '').toLowerCase();
        }

        let currentScenarioIndex = 0;
        let completionStatus; 

        // Definici贸n de los escenarios de aprendizaje
        const SCENARIOS = [
            {
                id: 0,
                title: "0. Introducci贸n a Python",
                explanation: `Python es uno de los lenguajes de programaci贸n m谩s populares del mundo. Es conocido por su sintaxis clara y legible, lo que lo hace perfecto para principiantes.

                <p class="mt-3">Se utiliza en campos como desarrollo web, ciencia de datos, inteligencia artificial y automatizaci贸n.</p>
                
                [Image of Python logo]`,
                task: "No hay ejercicio en esta unidad. Presiona 'Siguiente Unidad' para comenzar.",
                validation: (code) => {
                    return { 
                        success: true, 
                        feedback: "隆Bienvenido! Es hora de empezar a programar.",
                        consoleOutput: "Iniciando el curso de Python..." 
                    };
                }
            },
            {
                id: 1,
                title: "1. Variables y Asignaci贸n",
                explanation: `Una variable es un nombre que se refiere a un valor en la memoria de la computadora. Es como una etiqueta que le pones a una caja para saber qu茅 contiene.

                <p class="mt-3">Para asignar un valor, usamos el signo igual: <code>nombre_variable = valor</code>.</p>`,
                task: "Crea una variable llamada **'puntuacion'** y as铆gnale el valor entero **95**.",
                validation: (code) => {
                    const normalized = normalizeCode(code);
                    
                    // Regex flexible: busca 'puntuacion' seguida de '=' y '95'
                    // Esto permite 'puntuacion=95', 'puntuacion = 95', 'puntuacion= 95', etc.
                    const regex = /puntuacion=95/;

                    if (!regex.test(normalized)) {
                        return { success: false, feedback: "Aseg煤rate de que la variable se llame **'puntuacion'** y el valor sea el **n煤mero 95**. (ejemplo: `puntuacion = 95`)" };
                    }
                    return { 
                        success: true, 
                        feedback: "隆Excelente! La variable 'puntuacion' ha sido declarada y asignada correctamente.",
                        consoleOutput: "La variable 'puntuacion' ha sido establecida a 95."
                    };
                }
            },
            {
                id: 2,
                title: "2. Tipos de Datos: String e Impresi贸n",
                explanation: `Una 'string' (cadena de texto) es una secuencia de caracteres, y siempre se encierra entre comillas (simples o dobles).

                <p class="mt-3">La funci贸n <code>print()</code> se usa para mostrar texto o el valor de una variable en la consola. Puedes concatenar (unir) strings con el operador <code>+</code>.</p>`,
                task: "Declara una variable **'saludo'** con el valor 'Hola ' (con un espacio final) y otra **'nombre'** con tu nombre. Luego, imprime la concatenaci贸n de ambas variables.",
                validation: (code) => {
                    const normalized = normalizeCode(code);
                    
                    // 1. Declaraci贸n de saludo flexible (permite comillas simples o dobles y variaciones de espacios)
                    if (!/saludo=['"]hola['"]\+?/.test(normalized) && !/saludo=['"]hola\s['"]\+?/.test(normalized)) {
                        return { success: false, feedback: "Falta o es incorrecta la variable 'saludo'. Debe contener 'Hola ' (con un espacio) o 'Hola'." };
                    }

                    // 2. Declaraci贸n de nombre (cualquier string)
                    if (!/nombre=['"].+['"]/.test(normalized)) {
                         return { success: false, feedback: "Falta o es incorrecta la variable 'nombre'. Aseg煤rate de que tenga un valor de string (ej. 'Mundo')." };
                    }

                    // 3. Uso de print() con la concatenaci贸n. Usa la versi贸n original del c贸digo, ya que normalizeCode rompe la concatenaci贸n en el patr贸n.
                    // Busca 'print(saludo + nombre)' o 'print(nombre + saludo)'
                    if (!/print\s*\(\s*saludo\s*\+\s*nombre\s*\)/.test(code.replace(/\s/g, '')) && !/print\s*\(\s*nombre\s*\+\s*saludo\s*\)/.test(code.replace(/\s/g, ''))) {
                        return { success: false, feedback: "Aseg煤rate de usar la funci贸n 'print(saludo + nombre)' o 'print(nombre + saludo)' para concatenar e imprimir las variables." };
                    }

                    return { 
                        success: true, 
                        feedback: "隆Correcto! Has usado variables de tipo string y la funci贸n 'print' para concatenarlas.",
                        consoleOutput: "Hola Mundo" 
                    };
                }
            },
            {
                id: 3,
                title: "3. Estructuras de Control: Condicionales (if/else)",
                explanation: `Las estructuras condicionales (<code>if</code>, <code>elif</code>, <code>else</code>) permiten que el programa tome decisiones. El bloque de c贸digo bajo un 'if' solo se ejecuta si la condici贸n es verdadera (True).

                <p class="mt-3">隆Recuerda la indentaci贸n y los dos puntos (:)!</p>`,
                task: "Dado que ya existe la variable `numero = 15`. Escribe una estructura `if` que imprima **'El n煤mero es grande'** si `numero` es mayor que 10, y un `else` que imprima **'El n煤mero es peque帽o'** en caso contrario.",
                validation: (code) => {
                    const result = { success: false, feedback: "" };
                    
                    // Normalizaci贸n parcial para buscar la estructura, manteniendo espacios y saltos de l铆nea para la indentaci贸n
                    const normalizedStructure = code.replace(/\s+/g, ' ').trim(); 

                    // 1. Verificar la estructura del if (flexible con espacios y comillas)
                    const ifRegex = /if\s+numero\s*>\s*10\s*:\s*print\s*\(['"]El n煤mero es grande['"]\)/s;
                    if (!ifRegex.test(normalizedStructure)) {
                        result.feedback = "El bloque 'if' es incorrecto o no imprime el mensaje exacto: **'El n煤mero es grande'**. Verifica la condici贸n (`numero > 10`) y la indentaci贸n.";
                        return result;
                    }

                    // 2. Verificar la estructura del else (flexible con espacios y comillas)
                    const elseRegex = /else\s*:\s*print\s*\(['"]El n煤mero es peque帽o['"]\)/s;
                    if (!elseRegex.test(normalizedStructure)) {
                        result.feedback = "El bloque 'else' es incorrecto o no imprime el mensaje exacto: **'El n煤mero es peque帽o'**. Verifica la indentaci贸n.";
                        return result;
                    }
                    
                    return { 
                        success: true, 
                        feedback: "隆Fant谩stico! Has implementado el condicional 'if/else' correctamente.",
                        consoleOutput: "El n煤mero es grande"
                    };
                }
            },
            {
                id: 4,
                title: "4. Operaciones Aritm茅ticas",
                explanation: `Python soporta las operaciones matem谩ticas b谩sicas: suma (<code>+</code>), resta (<code>-</code>), multiplicaci贸n (<code>*</code>), divisi贸n (<code>/</code>), y m贸dulo (<code>%</code>, para obtener el residuo).

                <p class="mt-3">La jerarqu铆a de operaciones se respeta (PEMDAS/BODMAS). Usa par茅ntesis para forzar un orden espec铆fico.</p>`,
                task: "Calcula el resultado de la siguiente expresi贸n: `(20 + 5) * 2`. Almacena el resultado en una variable llamada **'total_calculado'** y luego impr铆mela.",
                validation: (code) => {
                    const result = { success: false, feedback: "" };
                    const normalized = normalizeCode(code);

                    // 1. Verificar la asignaci贸n de la variable y la operaci贸n (permite espacios flexibles)
                    // Buscamos 'total_calculado=' y la operaci贸n '((20+5)*2)' con par茅ntesis
                    if (!/total_calculado=\(20\+5\)\*2/.test(normalized)) {
                        result.feedback = "Aseg煤rate de asignar la variable **'total_calculado'** con la operaci贸n exacta `(20 + 5) * 2`. No uses el resultado final, sino la expresi贸n.";
                        return result;
                    }
                    
                    // 2. Verificar el uso de print (flexible con espacios)
                    if (!/print\(total_calculado\)/.test(normalized)) {
                        result.feedback = "Debes usar la funci贸n **'print(total_calculado)'** para mostrar el resultado.";
                        return result;
                    }

                    return { 
                        success: true, 
                        feedback: "隆C谩lculo exitoso! El orden de operaciones se aplic贸 correctamente. El resultado es 50.",
                        consoleOutput: "50"
                    };
                }
            },
            {
                id: 5,
                title: "5. Estructuras de Control: Bucle for",
                explanation: `El bucle <code>for</code> se utiliza para iterar sobre una secuencia (como una lista o un rango). Es ideal para repetir una tarea un n煤mero conocido de veces.

                <p class="mt-3">La funci贸n <code>range(n)</code> genera una secuencia de n煤meros desde 0 hasta **n-1**.</p>`,
                task: "Escribe un bucle `for` que itere 3 veces, usando `range(3)`, e imprima la palabra **'Repetici贸n'** en cada iteraci贸n.",
                validation: (code) => {
                    const result = { success: false, feedback: "" };

                    // Normalizaci贸n parcial para buscar la estructura, manteniendo espacios y saltos de l铆nea para la indentaci贸n
                    const normalizedStructure = code.replace(/\s+/g, ' ').trim(); 

                    // 1. Verificar la estructura del bucle for (flexible con el nombre de la variable de iteraci贸n y espacios)
                    // Busca 'for' seguido de un nombre de variable, 'in range(3):', y luego el print indentado.
                    const forRegex = /for\s+\w+\s+in\s+range\s*\(\s*3\s*\)\s*:\s*print\s*\(['"]Repetici贸n['"]\)/s;

                    if (!forRegex.test(normalizedStructure)) {
                        result.feedback = "Revisa tu sintaxis. Aseg煤rate de usar `for`, `range(3)` y la indentaci贸n correcta para imprimir **'Repetici贸n'** dentro del bucle.";
                        return result;
                    }
                    
                    return { 
                        success: true, 
                        feedback: "隆Lo tienes! El bucle se ejecut贸 3 veces. La iteraci贸n es clave en la programaci贸n.",
                        consoleOutput: "Repetici贸n\nRepetici贸n\nRepetici贸n"
                    };
                }
            },
            {
                id: 6,
                title: "6. Colecciones: Listas",
                explanation: `Las listas son una colecci贸n ordenada y modificable de 铆tems. Se definen con corchetes (<code>[]</code>) y pueden contener diferentes tipos de datos.

                <p class="mt-3">Accedes a los elementos mediante su 铆ndice (posici贸n), que empieza en 0.</p>`,
                task: "Crea una lista llamada **'frutas'** con los elementos **'manzana'**, **'banana'** y **'cereza'**. Luego, imprime el elemento en la segunda posici贸n (铆ndice 1).",
                validation: (code) => {
                    const result = { success: false, feedback: "" };
                    const normalized = normalizeCode(code);

                    // 1. Verificar la creaci贸n de la lista (flexible con espacios y comillas)
                    const listRegex = /frutas=\['?manzana'?,['"]?banana['"]?,['"]?cereza['"]?\]/;
                    if (!listRegex.test(normalized)) {
                        result.feedback = "Aseg煤rate de crear la lista **'frutas'** exactamente con los tres elementos indicados: 'manzana', 'banana' y 'cereza'.";
                        return result;
                    }

                    // 2. Verificar la impresi贸n del 铆ndice 1 (flexible con espacios)
                    if (!/print\(frutas\[1\]\)/.test(normalized)) {
                        result.feedback = "Debes imprimir el elemento en la segunda posici贸n usando **'print(frutas[1])'**.";
                        return result;
                    }
                    
                    return { 
                        success: true, 
                        feedback: "隆Genial! Has creado y accedido correctamente a una lista. El elemento en el 铆ndice 1 es 'banana'.",
                        consoleOutput: "banana"
                    };
                }
            },
            {
                id: 7,
                title: "7. Estructuras de Control: Bucle while",
                explanation: `El bucle <code>while</code> repite un bloque de c贸digo **mientras** una condici贸n sea verdadera. Es importante incluir una manera de que la condici贸n se vuelva falsa para evitar un bucle infinito.

                <p class="mt-3">A menudo se usa para tareas que necesitan repetirse hasta que se cumpla un criterio desconocido.</p>`,
                task: "Usa un bucle `while` para imprimir los n煤meros desde 0 hasta 2 (inclusive). Usa una variable `contador` inicializada a 0 y la condici贸n `contador < 3`. No olvides incrementar el contador.",
                validation: (code) => {
                    const result = { success: false, feedback: "" };
                    const normalized = normalizeCode(code);
                    const normalizedStructure = code.replace(/\s+/g, ' ').trim(); 

                    // 1. Verificar la inicializaci贸n
                    if (!/contador=0/.test(normalized)) {
                        result.feedback = "Aseg煤rate de inicializar la variable **'contador'** a 0.";
                        return result;
                    }
                    
                    // 2. Verificar la condici贸n while y la impresi贸n
                    const whilePrintRegex = /while\s+contador\s*<\s*3\s*:\s*print\s*\(\s*contador\s*\)/s;
                    if (!whilePrintRegex.test(normalizedStructure)) {
                        result.feedback = "El bucle 'while' es incorrecto. Debe usar la condici贸n **'contador < 3'** e imprimir **'contador'** dentro del bucle.";
                        return result;
                    }

                    // 3. Verificar el incremento (corta y larga forma)
                    if (!/contador=contador\+1/.test(normalized) && !/contador\+=1/.test(normalized)) {
                        result.feedback = "Debes incrementar el **'contador'** (ej. `contador = contador + 1` o `contador += 1`) dentro del bucle para evitar un bucle infinito.";
                        return result;
                    }

                    return { 
                        success: true, 
                        feedback: "隆Bucle 'while' dominado! El c贸digo imprimi贸 los n煤meros 0, 1 y 2, y luego se detuvo.",
                        consoleOutput: "0\n1\n2"
                    };
                }
            },
            {
                id: 8,
                title: "8. Modularidad: Funciones",
                explanation: `Una funci贸n es un bloque de c贸digo reutilizable que solo se ejecuta cuando se llama. Las funciones ayudan a organizar el c贸digo y evitar la repetici贸n.

                <p class="mt-3">Se definen con la palabra clave <code>def</code>. Para ejecutarlas, las llamas por su nombre seguido de par茅ntesis (ej. <code>mi_funcion()</code>).</p>`,
                task: "Define una funci贸n llamada **'saludar'** que tome un argumento `nombre` e imprima el mensaje 'Hola, [nombre]!'. Llama a la funci贸n con el nombre **'Ana'**.",
                validation: (code) => {
                    const result = { success: false, feedback: "" };
                    const normalizedStructure = code.replace(/\s+/g, ' ').trim(); 

                    // 1. Verificar la definici贸n de la funci贸n (flexible con espacios)
                    if (!/def\s+saludar\s*\(\s*nombre\s*\)\s*:/.test(normalizedStructure)) {
                        result.feedback = "Aseg煤rate de definir la funci贸n **'saludar'** con el par谩metro **'nombre'** usando la sintaxis `def saludar(nombre):`.";
                        return result;
                    }
                    
                    // 2. Verificar la impresi贸n con concatenaci贸n o f-string (flexible)
                    // Patr贸n de print(string + nombre + string) O print(f-string)
                    const printRegex = /print\s*\(\s*['"]Hola,\s*['"]\s*\+\s*nombre\s*\+\s*['"]!\s*['"]\s*\)/s;
                    const fstringRegex = /print\s*\(\s*f['"].*nombre.*!\s*['"]\s*\)/s;

                    if (!printRegex.test(normalizedStructure) && !fstringRegex.test(normalizedStructure)) {
                        result.feedback = "La funci贸n debe imprimir el saludo exacto: 'Hola, [nombre]!'. Usa la concatenaci贸n o una f-string.";
                        return result;
                    }

                    // 3. Verificar la llamada a la funci贸n (flexible con espacios y comillas)
                    if (!/saludar\s*\(\s*['"]Ana['"]\s*\)/.test(normalizedStructure)) {
                        result.feedback = "Debes llamar a la funci贸n usando **'saludar(\"Ana\")'**.";
                        return result;
                    }

                    return { 
                        success: true, 
                        feedback: "隆Perfecto! Has creado y ejecutado una funci贸n con un argumento.",
                        consoleOutput: "Hola, Ana!"
                    };
                }
            },
            {
                id: 9,
                title: "9. Robustez: Manejo de Errores",
                explanation: `El manejo de errores (o excepciones) con <code>try</code> y <code>except</code> permite que tu programa contin煤e ejecut谩ndose incluso si ocurre un error previsible.

                <p class="mt-3">El c贸digo riesgoso va en el bloque <code>try</code>, y la respuesta al error espec铆fico (como <code>ZeroDivisionError</code>) va en <code>except</code>.</p>`,
                task: "Escribe un bloque `try` y `except` para manejar una divisi贸n por cero. En el `try`, intenta dividir **10 / 0**. En el bloque `except ZeroDivisionError`, imprime el mensaje **'Error: Divisi贸n por cero no permitida.'**",
                validation: (code) => {
                    const result = { success: false, feedback: "" };
                    const normalizedStructure = code.replace(/\s+/g, ' ').trim(); 
                    
                    // 1. Verificar el bloque try con la divisi贸n (flexible con espacios)
                    if (!/try\s*:\s*10\s*\/\s*0/.test(normalizedStructure)) {
                        result.feedback = "El bloque **'try'** debe contener la operaci贸n riesgosa **'10 / 0'**.";
                        return result;
                    }
                    
                    // 2. Verificar el except con el tipo de error y el print (flexible)
                    const exceptRegex = /except\s+ZeroDivisionError\s*:\s*print\s*\(['"]Error:\s*Divisi贸n\s*por\s*cero\s*no\s*permitida\.["]\s*\)/s;

                    if (!exceptRegex.test(normalizedStructure)) {
                        result.feedback = "Debes capturar el error espec铆fico usando **'except ZeroDivisionError:'** e imprimir el mensaje exacto: **'Error: Divisi贸n por cero no permitida.'**.";
                        return result;
                    }

                    return { 
                        success: true, 
                        feedback: "隆Excelente! Has manejado la excepci贸n con 茅xito. Tu c贸digo es m谩s robusto.",
                        consoleOutput: "Error: Divisi贸n por cero no permitida."
                    };
                }
            }
        ];

        /**
         * Funci贸n para actualizar el estado de bloqueo visual en el sidebar.
         * Muestra un candado () si la unidad anterior no ha sido completada.
         */
        function updateSidebarLockStatus() {
            SCENARIOS.forEach((scenario, index) => {
                const navItem = document.getElementById(`nav-item-${index}`);
                
                // La unidad 0 (Introducci贸n) siempre est谩 disponible.
                if (index > 0) {
                    const isPreviousCompleted = completionStatus[index - 1];
                    
                    if (isPreviousCompleted) {
                        // Desbloqueado: se puede hacer clic
                        navItem.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-900/50');
                        navItem.classList.add('hover:bg-white/10');
                        navItem.innerHTML = `<span class="text-white">${scenario.title}</span>`;
                    } else {
                        // Bloqueado: no se puede hacer clic, icono de candado
                        navItem.classList.add('opacity-50', 'cursor-not-allowed');
                        navItem.classList.remove('hover:bg-white/10');
                        navItem.innerHTML = `<span class="mr-1" title="Unidad Bloqueada">&#128274;</span> ${scenario.title}`;
                    }
                } else {
                    // Unidad 0 siempre disponible y con el formato limpio
                    navItem.innerHTML = `<span class="text-white">${scenario.title}</span>`;
                }
            });
        }


        // Funci贸n para cargar el escenario actual
        function loadScenario(index) {
            
            const resultsArea = document.getElementById('results-area');
            const feedbackMessage = document.getElementById('feedback-message');
            const nextButton = document.getElementById('next-button');
            const consoleOutputContainer = document.getElementById('console-output-container');
            const consoleOutputEl = document.getElementById('console-output');

            // L贸gica de Bloqueo: Si el 铆ndice es mayor que 0 y el escenario anterior NO est谩 completado
            if (index > 0 && !completionStatus[index - 1]) {
                const lastCompletedIndex = completionStatus.lastIndexOf(true);
                const goToIndex = lastCompletedIndex === -1 ? 0 : lastCompletedIndex;

                // Muestra un mensaje de bloqueo con el estilo de error
                resultsArea.classList.remove('hidden', 'feedback-success');
                resultsArea.classList.add('feedback-error');
                feedbackMessage.textContent = "隆Unidad Bloqueada! Debes completar el escenario anterior para acceder a este tema.";
                nextButton.classList.add('hidden');
                consoleOutputContainer.classList.add('hidden'); // Ocultar consola en bloqueo

                // Si se intent贸 navegar directamente a una unidad bloqueada, volvemos a la 煤ltima completada.
                if (index !== currentScenarioIndex) {
                    loadScenario(goToIndex); 
                }
                return;
            }

            currentScenarioIndex = index;
            const scenario = SCENARIOS[index];

            // 1. Actualizar Navegaci贸n
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-item-${index}`).classList.add('active');

            // 2. Actualizar Contenido
            document.getElementById('topic-title').textContent = scenario.title;
            document.getElementById('theory-section').innerHTML = scenario.explanation;
            
            // 3. Actualizar Escenario de Pr谩ctica
            const taskEl = document.getElementById('task-description');
            const editorEl = document.getElementById('code-editor');
            const runButton = document.getElementById('run-button');

            if (scenario.task) {
                taskEl.innerHTML = scenario.task;
                // Mantener el valor predeterminado si existe, sino limpiarlo
                editorEl.value = (scenario.id === 3 ? "numero = 15\n# Escribe tu c贸digo aqu铆...\n" : 
                                  scenario.id === 4 ? "# Escribe tu c贸digo aqu铆...\n" : 
                                  scenario.id === 5 ? "# Escribe tu c贸digo aqu铆...\n" : 
                                  scenario.id === 6 ? "# Escribe tu c贸digo aqu铆...\n" : 
                                  scenario.id === 7 ? "contador = 0\n# Escribe tu c贸digo aqu铆...\n" : 
                                  scenario.id === 8 ? "# Escribe tu c贸digo aqu铆...\n" : 
                                  scenario.id === 9 ? "# Escribe tu c贸digo aqu铆...\n" : 
                                  "");
                editorEl.classList.remove('hidden');
                runButton.classList.remove('hidden');
            } else {
                // Escenario sin tarea (como la introducci贸n)
                taskEl.textContent = scenario.task || "No hay ejercicio en esta unidad.";
                editorEl.value = "";
                editorEl.classList.add('hidden');
                runButton.classList.add('hidden');
            }
            
            // 4. Limpiar Resultados y Consola
            resultsArea.classList.add('hidden');
            nextButton.classList.add('hidden');
            consoleOutputContainer.classList.add('hidden');


            // 5. Si la unidad ya fue completada, mostrar el bot贸n de siguiente y la salida simulada
            if (completionStatus[index]) {
                resultsArea.classList.remove('hidden', 'feedback-error');
                resultsArea.classList.add('feedback-success');
                feedbackMessage.textContent = "隆Ya has completado este escenario! Puedes pasar al siguiente.";
                nextButton.classList.remove('hidden');
                
                // Para mostrar la salida anterior, ejecutamos la validaci贸n sin c贸digo (la salida es est谩tica)
                const completedOutput = SCENARIOS[index].validation(""); // Pasamos string vac铆o

                if (completedOutput.consoleOutput) {
                    consoleOutputEl.textContent = completedOutput.consoleOutput;
                    consoleOutputContainer.classList.remove('hidden');
                }
            }
        }

        // Funci贸n para manejar el bot贸n de Ejecutar/Verificar
        function runCode() {
            const code = document.getElementById('code-editor').value;
            const scenario = SCENARIOS[currentScenarioIndex];
            const resultsArea = document.getElementById('results-area');
            const feedbackMessage = document.getElementById('feedback-message');
            const nextButton = document.getElementById('next-button');
            const consoleOutputContainer = document.getElementById('console-output-container');
            const consoleOutputEl = document.getElementById('console-output');

            // Validar el c贸digo usando la funci贸n espec铆fica del escenario
            const validationResult = scenario.validation(code);

            resultsArea.classList.remove('hidden');
            feedbackMessage.textContent = validationResult.feedback;
            nextButton.classList.add('hidden'); // Ocultar por defecto
            consoleOutputContainer.classList.remove('hidden'); // Mostrar el contenedor de la consola

            if (validationResult.success) {
                // xito
                resultsArea.classList.remove('feedback-error');
                resultsArea.classList.add('feedback-success');
                
                // Mostrar salida simulada de la consola
                if (validationResult.consoleOutput) {
                    consoleOutputEl.textContent = validationResult.consoleOutput;
                } else {
                    consoleOutputEl.textContent = "El c贸digo se ejecut贸 correctamente. No se detect贸 salida en la consola.";
                }
                
                // Marcar el escenario como completado y actualizar la interfaz
                completionStatus[currentScenarioIndex] = true;
                localStorage.setItem('completionStatus', JSON.stringify(completionStatus)); // Guardar estado
                updateSidebarLockStatus();

                // Mostrar bot贸n para avanzar
                if (currentScenarioIndex < SCENARIOS.length - 1) {
                    nextButton.classList.remove('hidden');
                } else {
                    feedbackMessage.textContent += " 隆Has completado todas las unidades iniciales!";
                }

            } else {
                // Error
                resultsArea.classList.remove('feedback-success');
                resultsArea.classList.add('feedback-error');

                // Mostrar el feedback del error en el 谩rea de la consola
                consoleOutputEl.textContent = `ERROR de Validaci贸n:\n${validationResult.feedback}`;
            }
        }

        // Funci贸n para avanzar al siguiente escenario
        function loadNextScenario() {
            const nextIndex = currentScenarioIndex + 1;
            if (nextIndex < SCENARIOS.length) {
                loadScenario(nextIndex);
            } else {
                // Fin de los escenarios
                const resultsArea = document.getElementById('results-area');
                const feedbackMessage = document.getElementById('feedback-message');
                
                resultsArea.classList.remove('hidden', 'feedback-error');
                resultsArea.classList.add('feedback-success');
                feedbackMessage.textContent = "隆Felicidades! Has completado todos los escenarios iniciales.";
                document.getElementById('next-button').classList.add('hidden');
                document.getElementById('console-output-container').classList.add('hidden');
            }
        }

        // Funci贸n de inicializaci贸n
        function initApp() {
            const unitList = document.getElementById('unit-list');
            
            // Inicializar el estado de completado
            const storedCompletionStatus = localStorage.getItem('completionStatus');
            if (storedCompletionStatus) {
                try {
                    completionStatus = JSON.parse(storedCompletionStatus);
                    while (completionStatus.length < SCENARIOS.length) {
                        completionStatus.push(false);
                    }
                } catch (e) {
                    console.error("Error al parsear completionStatus, reiniciando.", e);
                    completionStatus = new Array(SCENARIOS.length).fill(false);
                }
            } else {
                completionStatus = new Array(SCENARIOS.length).fill(false);
            }

            // El primer escenario (Introducci贸n) siempre se considera completado.
            completionStatus[0] = true; 

            // Crear los 铆tems de navegaci贸n
            SCENARIOS.forEach((scenario, index) => {
                const li = document.createElement('li');
                li.className = "mb-2";
                const a = document.createElement('a');
                a.id = `nav-item-${index}`;
                a.href = "#";
                a.textContent = scenario.title;
                a.className = "nav-item block transition duration-150 cursor-pointer";
                a.onclick = (e) => {
                    e.preventDefault();
                    // Impedir el clic si est谩 bloqueado
                    if (index > 0 && !completionStatus[index - 1]) {
                        return;
                    }
                    loadScenario(index);
                };
                li.appendChild(a);
                unitList.appendChild(li);
            });
            
            // Actualizar el estado inicial de bloqueo antes de cargar
            updateSidebarLockStatus();

            // Determinar qu茅 escenario cargar al inicio
            let initialIndex = 0;
            for (let i = 0; i < completionStatus.length; i++) {
                if (completionStatus[i]) {
                    initialIndex = i;
                } else {
                    initialIndex = i;
                    break;
                }
            }
            loadScenario(initialIndex);
        }

        // Iniciar la aplicaci贸n al cargar la p谩gina
        window.onload = initApp;

    </script>
</body>
</html>